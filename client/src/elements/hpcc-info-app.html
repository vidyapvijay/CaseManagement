
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/paper-styles/color.html">
<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html">

<link rel="import" href="../../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-label/iron-label.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-label/iron-label.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid.html">


<link rel="import" href="info-box.html">
<link rel="import" href="new-worksheet-dialog.html">
<link rel="import" href="open-worksheet-dialog.html">
<link rel="import" href="dialog-button.html">
<link rel="import" href="my-login.html">
<link rel="import" href="na-behavior.html">

<dom-module id="hpcc-info-app">

    <template>
        <iron-ajax id="ajaxRetrieveAllProjects" method="GET" handle-as="json" on-response="ajaxRetrieveAllProjectsResponse">
        </iron-ajax>
        <iron-ajax id="ajaxRetrieveProjectByName" method="GET" handle-as="json" on-response="ajaxRetrieveProjectByNameResponse">
        </iron-ajax>
        <iron-ajax id="ajaxGetProjectByProjectID" method="GET" handle-as="json" on-response="ajaxGetProjectByProjectIDResponse">
        </iron-ajax>
        <iron-ajax id="ajaxAddProject" method="POST" handle-as="json" on-response="ajaxAddProjectResponse">
        </iron-ajax>
        <iron-ajax id="ajaxUpdateProject" method="PUT" handle-as="json" on-response="ajaxUpdateProjectResponse">
        </iron-ajax>
        <style>
            
            app-toolbar {
                background-color: #4285f4;
                height: 50px;
                color: #fff;
            }
            
            main-title {
                margin-left: 15px;
                font-size: 18px;
            }

            app-drawer {
                --app-drawer-scrim-background: rgba(100, 100, 100, 0.8);
                --app-drawer-width: 300px;
            }

            paper-icon-button {
                --paper-icon-button: {
                    width: 36px;
                    height: 36px;
                }
            }

            .main {
                position: relative;
            }

            h2 {
                font-size: 16px;
                font-family: Helvetica, sans-serif;
                position: relative;
                padding: 0 0 0 10px;
                margin: 1em 0 .6em 0;
            }
           
            p {
                margin-left: 30px;
            }

            .headerLabels{
                color: gray;
                font-size: 12px;
                font-weight: bold;
            }

            .paperInputs {
                padding-left: 30px;
                padding-right: 20px;
            }

            paper-input.paperInputs {
                --paper-input-container-input-color: gray;
            }

            .btnSaveClusterDetails {
                background-color: #4caf50;
                color: white;
                text-transform: none;
                font-size: 15px;
                margin-left: 30px;
            }

            .toggleBtn {
                padding-left: 30px;
                padding-right: 20px;
                color: gray;
            }

            paper-toggle-button.toggleBtn {
                --paper-toggle-button-checked-bar-color:  var(--paper-indigo-500);
                --paper-toggle-button-checked-button-color:  var(--paper-indigo-500);
                --paper-toggle-button-checked-ink-color: var(--paper-indigo-500);
                --paper-toggle-button-unchecked-bar-color:  gray;
                --paper-toggle-button-unchecked-button-color:  gray;
                --paper-toggle-button-unchecked-ink-color: gray;
            }

            paper-button.green {
                background-color: var(--paper-green-500);
                color: white;
                text-transform: none;
                font-size: 15px;
            }


            paper-button.btnSaveClusterDetails {
                background-color: var(--paper-indigo-500);
                color: white;
                --paper-button-raised-keyboard-focus: {
                    background-color: var(--paper-pink-a200) !important;
                    color: white !important;
                }
                ;
            }

        </style>

        <app-location route="{{route}}"></app-location>

        <!-- ----------------------- App Drawer Left Position ---------------------------->
        <app-toolbar>
            <paper-icon-button icon="menu" onclick="drawer.toggle()" ></paper-icon-button>
            <div class="main-title" id="projecttitle">Welcome to HPCCInfo Application</div>
            <span style="flex: 1;"></span>
            <my-login signed-in="{{signedIn}}" user={{user}}></my-login>

        </app-toolbar> 
        <new-worksheet-dialog id="newwork"></new-worksheet-dialog>
        <open-worksheet-dialog id="openwork"></open-worksheet-dialog>
        
         <template is="dom-if" if="[[user]]">
             <info-box id="infobox"></info-box>
        </template>
       
        <app-drawer id="drawer" >
            <div class="listbx_div" role="listbox">
                <section class="main">
                    <h2><iron-label>Actions</iron-label></h2><hr>
                    <p><dialog-button id="new-worksheet-dialog" icon="create"></dialog-button>
                        <iron-label class="headerLabels">New Worksheet</iron-label>
                    </p>
                    <paper-tooltip for="new-worksheet-dialog" offset="10">New Worksheet</paper-tooltip>
                    <p><dialog-button id="open-worksheet-dialog" icon="mail"></dialog-button>
                        <iron-label class="headerLabels">Open Worksheet</iron-label>
                    </p>
                    <paper-tooltip for="open-worksheet-dialog" offset="10">Open Worksheet</paper-tooltip>

                    <h2><iron-label>Cluster Details</iron-label></h2><hr>
                    <paper-input class="paperInputs" id='cluster_name' label="Cluster Name" value="[[clustername]]"></paper-input>
                    <paper-input class="paperInputs" id='cluster_address' label="Cluster Address" value="[[clusteraddress]]"></paper-input>
                    <paper-input class="paperInputs" id='port' label="Port" value="[[port]]"></paper-input>
                    <paper-input class="paperInputs" id='username' label="Username" value="[[username]]"></paper-input>
                    <paper-input class="paperInputs" id='password' label="Password" value="[[password]]"></paper-input>
                    </br>
                    <paper-toggle-button class="toggleBtn" id="httpSecured">
                        <iron-label class="headerLabels">HTTP Secured</iron-label>
                    </paper-toggle-button></br></br>
                    <!--<paper-button class="btnSaveClusterDetails" on-tap="addAllToSession">Save Cluster Details</paper-button>-->
                    <paper-button style="background-color: #4caf50;;color: white;text-transform: none;"  on-tap="saveProjectDtls">Save</paper-button>

                    <!--<paper-button raised class="green" onclick="drawer.toggle()">Cancel</paper-button>-->
                </section>
            </div>
        </app-drawer>
    </template>
    
    <script>
   
        Polymer({
            is: 'hpcc-info-app',
            properties: {
                clusteraddress : {
                    type : String,
                    value : "10.173.147.1"
                },
                clustername : {
                    type : String,
                    value : "4-way"
                },
                port : {
                    type : String,
                    value : "8010"
                },
                httpSecured : Boolean,
                username    : String,
                password  : String,
                hideAppForSignin : {
                    type : Boolean,
                    value : true
                }, 
                 exportTo : {
                    type : String,
                    value : ''
                },
                user: {
                    type: Object,
                    notify: true,
                    observer: '_userChanged',
                },

                signedIn: {
                  type: Boolean,
                  notify: true,
                  value: false
                }
            },

            // This function is called evertime the user state changes (login/logout)
            _userChanged: function() {
                this.async(function() {                   
                    if(this.user !== null && this.user !== undefined) {
                        var infoBox = this.$$('#infobox');
                        try{
                            infoBox.properties.cluster_name =  "4-way";
                            infoBox.properties.cluster_address = "10.173.147.1";
                            infoBox.properties.port = "8010";
                            infoBox.properties.username = "";
                            infoBox.properties.password = "";
                            infoBox.properties.httpSecured = false;
                            infoBox.properties.updatedby = this.user.email;

                            var pluginId = "common-input";
                            infoBox.properties.projectid = 'projectid' + '_' +  Math.random().toString(36).substr(2, 4); 
                            infoBox.properties.title = 'Welcome to HPCCInfo Application';
                            infobox.addTab(pluginId, "Input", pluginId);

                            //Initialize projecttitle handler for inline editing of projecttitle
                            editProjectTitleHandler();  

                        }catch(e2){
                            console.log("Error occurred");
                        }
                    }
                                      
                }.bind(this), 50);

            },

            ready : function() {
                // If the user is not authenticated, this will redirect him to Home page.
                // This will take care if the user types in the protected page url in the browser and if the user refreshes the page
                if(this.user === null || this.user === undefined) {
                    this.set('route.path', '/');
                }
            },

            saveProjectDtls : function(event){
                document.querySelector('#drawer').toggle();
                var infoBox = this.$$('#infobox');
                var projectid = infobox.properties.projectid;
                this.$.ajaxRetrieveProjectByName.url = 'http://' + window.location.hostname + ':3000/projectDetails/' + projectid;
                this.$.ajaxRetrieveProjectByName.generateRequest();

            },

            exportProjectDtls : function(exportTo){
                document.querySelector('#drawer').toggle();
                this.$.exportTo =  exportTo;
                var infoBox = this.$$('#infobox');
                var projectid = infobox.properties.projectid;
                this.$.ajaxRetrieveProjectByName.url = 'http://' + window.location.hostname + ':3000/projectDetails/' + projectid;
                this.$.ajaxRetrieveProjectByName.generateRequest();

            },

            ajaxRetrieveProjectByNameResponse : function(eve){
                var infoBox = this.$$('#infobox');

                var insterOrUpdate = (this.$.ajaxRetrieveProjectByName.lastResponse.length > 0 ? 
                                      (( this.$.exportTo === undefined ||  this.$.exportTo === null || this.$.exportTo === '') ? false : true) : true);

                infoBox.properties.cluster_name = this.$.cluster_name.value;
                infoBox.properties.cluster_address = this.$.cluster_address.value;
                infoBox.properties.port = this.$.port.value;
                infoBox.properties.username = this.$.username.value;
                infoBox.properties.password = this.$.password.value;
                infoBox.properties.httpSecured = this.$.httpSecured.value;

                var tabs = infobox.querySelector('#tabs');

                var projectid = ( this.$.exportTo === undefined ||  this.$.exportTo === null || this.$.exportTo === '') ? infobox.properties.projectid : 'projectid' + '_' +  Math.random().toString(36).substr(2, 4);
                //  infobox.properties.projectid;

                var title = infobox.properties.title;

                var updatedby = ( this.$.exportTo === undefined ||  this.$.exportTo === null || this.$.exportTo === '') ? infobox.properties.updatedby :  this.$.exportTo;

                if(updatedby === undefined || updatedby === null ||updatedby === ''){
                    return;
                }
                
                infobox.properties.updatedby = updatedby;

                var dateupdated = infobox.properties.dateupdated;

                var file = infobox.properties.file;


                var projectJsonStr = '{\"updatedby\": \"' + updatedby + '\", \"projectdata\" : \"{\\"cluster_details\\":{';

                var projectJsonStr1 = '';

                projectJsonStr1 += '\"ip\" : \"' + infoBox.properties.cluster_address + '\",';
                projectJsonStr1 += '\"name\" :\"' + infoBox.properties.cluster_name + '\",';
                projectJsonStr1 += '\"port\" :\"' + infoBox.properties.port + '\",';
                projectJsonStr1 += '\"username\" :\"' + infoBox.properties.username + '\",';
                projectJsonStr1 += '\"password\" :\"' + infoBox.properties.password + '\",';
                projectJsonStr1 += '\"hpccsecured\" :\"' + infoBox.properties.httpSecured + '\"}, \"Tabs\":[';

                for(var cnt = 0 ; cnt < infoBox.viewList.length; cnt++){
                    projectJsonStr1 += infoBox.viewList[cnt].editor.serialize() + (cnt < infoBox.viewList.length -1 ? ',' : '');
                }

                projectJsonStr +=  projectJsonStr1.replace(/"/g, '\\"') + ' ]}\"' +  
                                   ',\"projectid\" : \"' + projectid + 
                                   '",\"udpatedby\" : \"' +  updatedby  + 
                                   '",\"dateupdated\" : \"' + new Date().toISOString().slice(0, 19).replace('T', ' ') + 
                                   '",\"file\" : \"' + file + 
                                    '",\"title\" : \"' + title + '\"}';

                
                console.log(projectJsonStr);

                console.log(JSON.parse(projectJsonStr));

                if(insterOrUpdate != true) {
                    this.$.ajaxUpdateProject.url = 'http://' + window.location.hostname + ':3000/projectDetails/' + projectid;

                    this.$.ajaxUpdateProject.body = JSON.stringify(JSON.parse(projectJsonStr));

                    this.$.ajaxUpdateProject.contentType =  'application/json';

                    this.$.ajaxUpdateProject.generateRequest();
                }else{
                    this.$.ajaxAddProject.url = 'http://' + window.location.hostname + ':3000/projectDetails';

                    this.$.ajaxAddProject.body = JSON.stringify(JSON.parse(projectJsonStr));

                    this.$.ajaxAddProject.contentType =  'application/json';

                    this.$.ajaxAddProject.generateRequest();
                }
            },
            addAllToSession  : function(event){

                 var infoBox = this.$$('#infobox');

                infoBox.properties.cluster_name = this.$.cluster_name.value;
                infoBox.properties.cluster_address = this.$.cluster_address.value;
                infoBox.properties.port = this.$.port.value;
                infoBox.properties.username = this.$.username.value;
                infoBox.properties.password = this.$.password.value;
                infoBox.properties.httpSecured = this.$.httpSecured.value;
                
            },


             addMeToSession : function(event){

                 var infoBox = this.$$('#infobox');
                switch(event.currentTarget.id){
                    case 'cluster_name' : 
                        infoBox.properties.cluster_name = event.currentTarget.value;
                        break;
                    case 'cluster_address' : 
                        infoBox.properties.cluster_address = event.currentTarget.value;
                        break;
                    case 'port':
                        infoBox.properties.port = event.currentTarget.value;
                        break;
                    case 'username':
                        infoBox.properties.username = event.currentTarget.value;
                        break;
                    case 'password':
                        infoBox.properties.password = event.currentTarget.value;
                        break;
                    case 'httpSecured':
                        infoBox.properties.httpSecured = event.currentTarget.value;
                        break;
                    default:
                        break;
                }
                console.log(event);
             }     

        });
    </script>

</dom-module>